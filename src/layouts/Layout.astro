---
// 引入導覽列組件
import Navbar from "../components/navbar.astro";
import { ClientRouter } from 'astro:transitions';

interface Props {
	title: string;
}

const { title } = Astro.props;

// 自動偵測當前路徑，用來高亮導覽列選單
// 例如在 /about 頁面時，currentPath 會是 "about"
const pathname = new URL(Astro.request.url).pathname;
const currentPath = pathname.slice(1).split('/')[0];
---

<!doctype html>
<html lang="zh-TW">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="曾冠瑜 Bruce 的個人網站 - 數位人文與語義分析研究者" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/cabbage.svg" />
		<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
		<ClientRouter />
	</head>
	<body transition:animate="fade">
		<div id="progress-bar"></div>
		<canvas id="click-canvas"></canvas>
		<div class="paper-texture"></div>

		<div class="sticky-nav">
			<div class="nav-inner">
				<Navbar currentPath={currentPath} />
			</div>
		</div>

		<div class="container">
			<slot />
		</div>

		<!-- 全站搜尋 Overlay -->
		<div id="search-overlay" class="search-overlay" aria-hidden="true">
			<div class="search-modal">
				<input id="search-input" type="text" placeholder="搜尋文章、音樂、書籍…" autocomplete="off" spellcheck="false" />
				<div id="search-results" class="search-results"></div>
			</div>
		</div>

		<script is:inline>
			function updateClock() {
				const el = document.getElementById("live-time");
				if (el) {
					const now = new Date();
					el.textContent = now.toLocaleTimeString("zh-TW", {
						hour12: false,
						hour: "2-digit",
						minute: "2-digit",
						second: "2-digit"
					});
				}
			}
			setInterval(updateClock, 1000);
			updateClock();
		</script>

		<!-- 點擊粒子特效 -->
		<script is:inline>
			var _clickCanvas, _clickCtx, _clickParticles = [], _rafId;

			function resizeClickCanvas() {
				_clickCanvas.width  = window.innerWidth;
				_clickCanvas.height = window.innerHeight;
			}

			function ClickParticle(x, y) {
				var angle = Math.random() * Math.PI * 2;
				var speed = Math.random() * 3.5 + 1;
				this.x = x; this.y = y;
				this.vx = Math.cos(angle) * speed;
				this.vy = Math.sin(angle) * speed;
				this.alpha  = 1;
				this.radius = Math.random() * 2.5 + 1;
				this.decay  = Math.random() * 0.025 + 0.018;
				this.gravity = 0.07;
			}
			ClickParticle.prototype.update = function() {
				this.vy += this.gravity;
				this.x  += this.vx; this.y += this.vy;
				this.vx *= 0.97;
				this.alpha -= this.decay;
			};
			ClickParticle.prototype.draw = function() {
				_clickCtx.save();
				_clickCtx.globalAlpha = Math.max(0, this.alpha);
				_clickCtx.fillStyle = "#8b4513";
				_clickCtx.beginPath();
				_clickCtx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
				_clickCtx.fill();
				_clickCtx.restore();
			};

			function spawnBurst(x, y, count) {
				for (var i = 0; i < (count || 10); i++) {
					_clickParticles.push(new ClickParticle(x, y));
				}
			}

			function clickLoop() {
				_clickCtx.clearRect(0, 0, _clickCanvas.width, _clickCanvas.height);
				_clickParticles = _clickParticles.filter(function(p) { return p.alpha > 0; });
				_clickParticles.forEach(function(p) { p.update(); p.draw(); });
				_rafId = requestAnimationFrame(clickLoop);
			}

			function initClickEffect() {
				if (_rafId) cancelAnimationFrame(_rafId);
				_clickParticles = [];
				_clickCanvas = document.getElementById("click-canvas");
				if (!_clickCanvas) return;
				_clickCtx = _clickCanvas.getContext("2d");
				resizeClickCanvas();
				window.addEventListener("resize", resizeClickCanvas);

				document.addEventListener("click", function(e) {
					spawnBurst(e.clientX, e.clientY, 6);
				});

				// 延遲 Astro 的頁面載入，讓粒子先跑完
				document.addEventListener("astro:before-preparation", function(e) {
					var orig = e.loader;
					e.loader = async function() {
						await new Promise(function(r) { setTimeout(r, 25); });
						return orig();
					};
				});

				clickLoop();
			}

			document.addEventListener("astro:page-load", initClickEffect);
		</script>

		<!-- 全站搜尋邏輯 -->
		<script is:inline>
			var _searchData = null;

			function openSearch() {
				var overlay = document.getElementById('search-overlay');
				var input = document.getElementById('search-input');
				if (!overlay || !input) return;
				overlay.classList.add('open');
				overlay.setAttribute('aria-hidden', 'false');
				input.value = '';
				document.getElementById('search-results').innerHTML = '';
				setTimeout(function() { input.focus(); }, 50);
			}

			function closeSearch() {
				var overlay = document.getElementById('search-overlay');
				if (!overlay) return;
				overlay.classList.remove('open');
				overlay.setAttribute('aria-hidden', 'true');
			}

			function renderResults(items) {
				var container = document.getElementById('search-results');
				if (!container) return;
				if (items.length === 0) {
					container.innerHTML = '<div class="search-empty">沒有找到相關結果</div>';
					return;
				}
				container.innerHTML = items.map(function(item) {
					return '<a href="' + item.url + '" class="search-result-item">' +
						'<span class="result-type">' + item.type + '</span>' +
						'<span class="result-title">' + item.title + '</span>' +
						(item.subtitle ? '<span class="result-subtitle">' + item.subtitle + '</span>' : '') +
						'</a>';
				}).join('');
			}

			function doSearch(query) {
				if (!query.trim()) {
					document.getElementById('search-results').innerHTML = '';
					return;
				}
				var q = query.toLowerCase();
				var results = (_searchData || []).filter(function(item) {
					return (item.title || '').toLowerCase().includes(q) ||
						(item.subtitle || '').toLowerCase().includes(q);
				});
				renderResults(results.slice(0, 12));
			}

			function initSearch() {
				var btn = document.getElementById('search-btn');
				var overlay = document.getElementById('search-overlay');
				var input = document.getElementById('search-input');
				if (!overlay || !input) return;

				if (btn) {
					btn.addEventListener('click', openSearch);
				}

				document.addEventListener('keydown', function(e) {
					if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
						e.preventDefault();
						openSearch();
					}
					if (e.key === 'Escape') {
						closeSearch();
					}
				});

				overlay.addEventListener('click', function(e) {
					if (e.target === overlay) closeSearch();
				});

				input.addEventListener('input', function() {
					if (!_searchData) {
						fetch('/search.json')
							.then(function(r) { return r.json(); })
							.then(function(data) {
								_searchData = data;
								doSearch(input.value);
							});
					} else {
						doSearch(input.value);
					}
				});

				document.getElementById('search-results').addEventListener('click', function() {
					closeSearch();
				});
			}

			document.addEventListener('astro:page-load', initSearch);
		</script>

		<script is:inline>
			function initProgress() {
				function update() {
					var bar = document.getElementById('progress-bar');
					if (!bar) return;
					var scrolled = window.scrollY;
					var total = document.documentElement.scrollHeight - window.innerHeight;
					bar.style.width = total > 0 ? (scrolled / total * 100) + '%' : '0%';
				}
				window.addEventListener('scroll', update, { passive: true });
				update();
			}
			document.addEventListener('astro:page-load', initProgress);
		</script>
	</body>
</html>

<style is:global>
	/* --- 全域變數定義 --- */
	:root {
		--ink: #2c2c2c;       /* 墨水黑 */
		--paper: #fdfaf6;     /* 紙張底色 */
		--accent: #8b4513;    /* 焦糖褐色（強調色） */
		--muted: #8e8e8e;     /* 輔助灰色 */
		--border: #e0dcd5;    /* 邊框色 */
	}

	/* --- 基礎樣式重置 --- */
	* {
		box-sizing: border-box;
	}

	html, body {
		margin: 0;
		padding: 0;
		width: 100%;
		min-height: 100vh;
		background-color: var(--paper);
		color: var(--ink);
		font-family: "Noto Serif TC", serif;
		line-height: 1.6;
	}

	/* 自訂游標 */
	* { cursor: url('/images/cursor_1-removebg-preview.png') 0 0, auto; }
	a, a *, button, button *, [role="button"], [role="button"] *,
	select, label[for], input[type="submit"] {
		cursor: url('/images/cursor_2-removebg-preview.png') 0 0, pointer !important;
	}

	/* 點擊粒子畫布 */
	#click-canvas {
		position: fixed;
		inset: 0;
		z-index: 9999;
		pointer-events: none;
	}

	/* 紙張紋理效果 */
	.paper-texture {
		position: fixed;
		inset: 0;
		z-index: -1;
		opacity: 0.03;
		background-image: url("https://www.transparenttextures.com/patterns/paper-fibers.png");
		pointer-events: none;
	}

	/* --- Sticky 導覽列 --- */
	.sticky-nav {
		position: sticky;
		top: 0;
		z-index: 100;
		background: rgba(253, 250, 246, 0.75);
		backdrop-filter: blur(12px);
		-webkit-backdrop-filter: blur(12px);
	}
	.nav-inner {
		max-width: 1400px;
		margin: 0 auto;
		padding: 0 4rem;
	}

	/* --- 核心容器：決定內容的寬度 --- */
	.container {
		max-width: 1400px;
		margin: 0 auto;
		padding: 2.5rem 4rem 3rem;
	}

	/* 標題與連結的基本樣式 */
	h1, h2, h3 {
		font-weight: 700;
		letter-spacing: -0.5px;
	}

	a {
		color: inherit;
		text-decoration: none;
		transition: 0.3s;
	}

	/* 響應式調整：在手機上減少邊距 */
	@media (max-width: 768px) {
		.nav-inner { padding: 0 1rem; }
		.container { padding: 1.5rem 1rem; }
	}

	/* --- 全站搜尋 Overlay --- */
	.search-overlay {
		position: fixed;
		inset: 0;
		z-index: 9000;
		background: rgba(253, 250, 246, 0.95);
		backdrop-filter: blur(8px);
		-webkit-backdrop-filter: blur(8px);
		display: flex;
		align-items: flex-start;
		justify-content: center;
		padding-top: 15vh;
		opacity: 0;
		pointer-events: none;
		transition: opacity 0.2s ease;
	}
	.search-overlay.open {
		opacity: 1;
		pointer-events: auto;
	}
	.search-modal {
		width: 100%;
		max-width: 600px;
		padding: 0 1.5rem;
	}
	#search-input {
		width: 100%;
		background: none;
		border: none;
		border-bottom: 2px solid var(--accent);
		outline: none;
		font-size: 1.2rem;
		font-family: "Noto Serif TC", serif;
		color: var(--ink);
		padding: 0.5rem 0;
		letter-spacing: 0.5px;
	}
	#search-input::placeholder { color: var(--muted); }
	.search-results {
		margin-top: 1.2rem;
		display: flex;
		flex-direction: column;
		gap: 2px;
	}
	.search-result-item {
		display: flex;
		align-items: baseline;
		gap: 0.8rem;
		padding: 0.65rem 0.8rem;
		border-radius: 3px;
		text-decoration: none;
		color: var(--ink);
		transition: background 0.2s;
	}
	.search-result-item:hover { background: rgba(139, 69, 19, 0.07); }
	.result-type {
		font-size: 0.58rem;
		font-family: sans-serif;
		letter-spacing: 2px;
		color: var(--accent);
		font-weight: 700;
		flex-shrink: 0;
		min-width: 60px;
	}
	.result-title {
		font-size: 0.92rem;
		font-weight: 700;
		flex: 1;
	}
	.result-subtitle {
		font-size: 0.78rem;
		color: var(--muted);
		font-family: sans-serif;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		max-width: 180px;
	}
	.search-empty {
		padding: 1rem 0.8rem;
		color: var(--muted);
		font-size: 0.85rem;
		font-family: sans-serif;
	}

	#progress-bar {
		position: fixed;
		top: 0;
		left: 0;
		height: 2px;
		width: 0%;
		background: var(--accent);
		z-index: 99999;
		pointer-events: none;
		transition: width 0.08s linear;
	}
</style>