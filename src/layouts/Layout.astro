---
// 引入導覽列組件
import Navbar from "../components/navbar.astro";
import { ClientRouter } from 'astro:transitions';

interface Props {
	title: string;
}

const { title } = Astro.props;

// 自動偵測當前路徑，用來高亮導覽列選單
// 例如在 /about 頁面時，currentPath 會是 "about"
const pathname = new URL(Astro.request.url).pathname;
const currentPath = pathname.slice(1).split('/')[0];
---

<!doctype html>
<html lang="zh-TW">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="曾冠瑜 Bruce 的個人網站 - 數位人文與語義分析研究者" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/cabbage.svg" />
		<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
		<ClientRouter />
	</head>
	<body transition:animate="fade">
		<canvas id="click-canvas"></canvas>
		<div class="paper-texture"></div>

		<div class="sticky-nav">
			<div class="nav-inner">
				<Navbar currentPath={currentPath} />
			</div>
		</div>

		<div class="container">
			<slot />
		</div>

		<script is:inline>
			function updateClock() {
				const el = document.getElementById("live-time");
				if (el) {
					const now = new Date();
					el.textContent = now.toLocaleTimeString("zh-TW", {
						hour12: false,
						hour: "2-digit",
						minute: "2-digit",
						second: "2-digit"
					});
				}
			}
			setInterval(updateClock, 1000);
			updateClock();
		</script>

		<!-- 點擊粒子特效 -->
		<script is:inline>
			var _clickCanvas, _clickCtx, _clickParticles = [], _rafId;

			function resizeClickCanvas() {
				_clickCanvas.width  = window.innerWidth;
				_clickCanvas.height = window.innerHeight;
			}

			function ClickParticle(x, y) {
				var angle = Math.random() * Math.PI * 2;
				var speed = Math.random() * 3.5 + 1;
				this.x = x; this.y = y;
				this.vx = Math.cos(angle) * speed;
				this.vy = Math.sin(angle) * speed;
				this.alpha  = 1;
				this.radius = Math.random() * 2.5 + 1;
				this.decay  = Math.random() * 0.025 + 0.018;
				this.gravity = 0.07;
			}
			ClickParticle.prototype.update = function() {
				this.vy += this.gravity;
				this.x  += this.vx; this.y += this.vy;
				this.vx *= 0.97;
				this.alpha -= this.decay;
			};
			ClickParticle.prototype.draw = function() {
				_clickCtx.save();
				_clickCtx.globalAlpha = Math.max(0, this.alpha);
				_clickCtx.fillStyle = "#8b4513";
				_clickCtx.beginPath();
				_clickCtx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
				_clickCtx.fill();
				_clickCtx.restore();
			};

			function spawnBurst(x, y, count) {
				for (var i = 0; i < (count || 10); i++) {
					_clickParticles.push(new ClickParticle(x, y));
				}
			}

			function clickLoop() {
				_clickCtx.clearRect(0, 0, _clickCanvas.width, _clickCanvas.height);
				_clickParticles = _clickParticles.filter(function(p) { return p.alpha > 0; });
				_clickParticles.forEach(function(p) { p.update(); p.draw(); });
				_rafId = requestAnimationFrame(clickLoop);
			}

			function initClickEffect() {
				if (_rafId) cancelAnimationFrame(_rafId);
				_clickParticles = [];
				_clickCanvas = document.getElementById("click-canvas");
				if (!_clickCanvas) return;
				_clickCtx = _clickCanvas.getContext("2d");
				resizeClickCanvas();
				window.addEventListener("resize", resizeClickCanvas);

				document.addEventListener("click", function(e) {
					spawnBurst(e.clientX, e.clientY, 6);
				});

				// 延遲 Astro 的頁面載入，讓粒子先跑完
				document.addEventListener("astro:before-preparation", function(e) {
					var orig = e.loader;
					e.loader = async function() {
						await new Promise(function(r) { setTimeout(r, 25); });
						return orig();
					};
				});

				clickLoop();
			}

			document.addEventListener("astro:page-load", initClickEffect);
		</script>
	</body>
</html>

<style is:global>
	/* --- 全域變數定義 --- */
	:root {
		--ink: #2c2c2c;       /* 墨水黑 */
		--paper: #fdfaf6;     /* 紙張底色 */
		--accent: #8b4513;    /* 焦糖褐色（強調色） */
		--muted: #8e8e8e;     /* 輔助灰色 */
		--border: #e0dcd5;    /* 邊框色 */
	}

	/* --- 基礎樣式重置 --- */
	* {
		box-sizing: border-box;
	}

	html, body {
		margin: 0;
		padding: 0;
		width: 100%;
		min-height: 100vh;
		background-color: var(--paper);
		color: var(--ink);
		font-family: "Noto Serif TC", serif;
		line-height: 1.6;
	}

	/* 自訂游標 */
	* { cursor: url('/images/cursor_1-removebg-preview.png') 0 0, auto; }
	a, a *, button, button *, [role="button"], [role="button"] *,
	select, label[for], input[type="submit"] {
		cursor: url('/images/cursor_2-removebg-preview.png') 0 0, pointer !important;
	}

	/* 點擊粒子畫布 */
	#click-canvas {
		position: fixed;
		inset: 0;
		z-index: 9999;
		pointer-events: none;
	}

	/* 紙張紋理效果 */
	.paper-texture {
		position: fixed;
		inset: 0;
		z-index: -1;
		opacity: 0.03;
		background-image: url("https://www.transparenttextures.com/patterns/paper-fibers.png");
		pointer-events: none;
	}

	/* --- Sticky 導覽列 --- */
	.sticky-nav {
		position: sticky;
		top: 0;
		z-index: 100;
		background: rgba(253, 250, 246, 0.75);
		backdrop-filter: blur(12px);
		-webkit-backdrop-filter: blur(12px);
	}
	.nav-inner {
		max-width: 1400px;
		margin: 0 auto;
		padding: 0 4rem;
	}

	/* --- 核心容器：決定內容的寬度 --- */
	.container {
		max-width: 1400px;
		margin: 0 auto;
		padding: 2.5rem 4rem 3rem;
	}

	/* 標題與連結的基本樣式 */
	h1, h2, h3 {
		font-weight: 700;
		letter-spacing: -0.5px;
	}

	a {
		color: inherit;
		text-decoration: none;
		transition: 0.3s;
	}

	/* 響應式調整：在手機上減少邊距 */
	@media (max-width: 768px) {
		.nav-inner { padding: 0 1rem; }
		.container { padding: 1.5rem 1rem; }
	}
</style>