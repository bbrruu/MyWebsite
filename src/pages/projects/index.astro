---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

const allProjects = (await getCollection("projects")).sort(
    (a: CollectionEntry<"projects">, b: CollectionEntry<"projects">) =>
        b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const categories = ["App", "Tool", "Experiment", "Other"];
---

<Layout title="作品集 | Side Projects - Bruce">
    <div class="paper-texture"></div>

    <main class="projects-archive">
        <header class="archive-header">
            <h1>作品集 <small>SIDE PROJECTS</small></h1>
            <div class="header-line"></div>

            <nav class="category-filter">
                <button class="cat-btn active" data-category="all">全部 ALL</button>
                {categories.map((cat) => (
                    <button class="cat-btn" data-category={cat}>{cat}</button>
                ))}
            </nav>
        </header>

        <div class="projects-grid" id="projects-list">
            {allProjects.map((project: CollectionEntry<"projects">) => (
                <a href={`/projects/${project.id}`} class="project-card" data-cat={project.data.category}>
                    <div class="card-cover">
                        {project.data.coverImage
                            ? <img src={project.data.coverImage} alt={project.data.title} />
                            : <div class="cover-placeholder"><span>{project.data.techStack[0] || "?"}</span></div>
                        }
                        <span class={`status-badge status--${project.data.status.toLowerCase()}`}>
                            {project.data.status}
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="card-meta">
                            <span class="card-category">{project.data.category}</span>
                            <span class="card-date">{project.data.pubDate.getFullYear()}</span>
                        </div>
                        <h2 class="card-title">{project.data.title}</h2>
                        <p class="card-desc">{project.data.description}</p>
                        <div class="card-tags">
                            {project.data.techStack.map((tech: string) => (
                                <span class="tech-tag">{tech}</span>
                            ))}
                        </div>
                        <div class="card-links">
                            {project.data.demoUrl && (
                                <span class="link-chip">Demo →</span>
                            )}
                            {project.data.githubUrl && (
                                <span class="link-chip">GitHub →</span>
                            )}
                        </div>
                    </div>
                </a>
            ))}
        </div>
    </main>
</Layout>

<script>
    const setup = () => {
        const buttons = document.querySelectorAll(".cat-btn");
        const cards = document.querySelectorAll(".project-card");
        if (!buttons.length) return;

        buttons.forEach((btn) => {
            btn.addEventListener("click", () => {
                const cat = btn.getAttribute("data-category")?.trim();
                buttons.forEach((b) => b.classList.remove("active"));
                btn.classList.add("active");
                cards.forEach((card) => {
                    const htmlCard = card as HTMLElement;
                    const cardCat = htmlCard.getAttribute("data-cat")?.trim();
                    htmlCard.style.display = (cat === "all" || cardCat === cat) ? "" : "none";
                });
            });
        });
    };
    document.addEventListener("DOMContentLoaded", setup);
    document.addEventListener("astro:page-load", setup);
</script>

<style>
    .projects-archive {
        max-width: 1400px;
        margin: 2rem auto;
        font-family: "Noto Serif TC", serif;
    }

    .archive-header h1 {
        font-size: 1.6rem; margin: 0; font-weight: 700; letter-spacing: -1.5px;
        display: flex; justify-content: space-between; align-items: baseline;
    }
    .archive-header h1 small {
        font-size: 0.75rem; font-family: sans-serif; letter-spacing: 4px;
        color: var(--muted); font-weight: 400;
    }
    .header-line { width: 100%; height: 1px; background: var(--border); margin: 1.2rem 0 1.5rem; position: relative; }
    .header-line::after { content: ''; position: absolute; left: 0; top: -1px; width: 80px; height: 3px; background: var(--accent); }

    .category-filter { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 3rem; }
    .cat-btn {
        background: none; border: none; padding: 0 1.5rem 0.8rem 0;
        font-size: 0.75rem; color: var(--muted); cursor: pointer;
        transition: color 0.3s; font-family: sans-serif; letter-spacing: 2px;
        position: relative; text-transform: uppercase;
    }
    .cat-btn.active { color: var(--accent); font-weight: 700; }
    .cat-btn.active::after { content: ""; position: absolute; bottom: -1px; left: 0; width: calc(100% - 1.5rem); height: 3px; background: var(--accent); }

    .projects-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
    }

    .project-card {
        text-decoration: none; color: inherit;
        border: 1px solid var(--border); border-radius: 4px;
        overflow: hidden; transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
        display: flex; flex-direction: column;
    }
    .project-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(139,69,19,0.1); border-color: var(--accent); }

    .card-cover { position: relative; height: 180px; overflow: hidden; background: var(--border); }
    .card-cover img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s; }
    .project-card:hover .card-cover img { transform: scale(1.04); }
    .cover-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(139,69,19,0.08), rgba(139,69,19,0.18)); }
    .cover-placeholder span { font-family: sans-serif; font-size: 0.8rem; letter-spacing: 4px; color: var(--accent); text-transform: uppercase; font-weight: 700; }

    .status-badge { position: absolute; top: 0.6rem; right: 0.6rem; font-size: 0.6rem; font-family: sans-serif; letter-spacing: 1px; padding: 2px 8px; border-radius: 20px; font-weight: 700; }
    .status--active { background: rgba(34,197,94,0.15); color: #16a34a; }
    .status--wip { background: rgba(249,115,22,0.15); color: #ea580c; }
    .status--archived { background: rgba(100,116,139,0.15); color: #64748b; }

    .card-body { padding: 1rem; display: flex; flex-direction: column; gap: 0.45rem; flex: 1; }
    .card-meta { display: flex; justify-content: space-between; align-items: center; }
    .card-category { font-size: 0.6rem; font-family: sans-serif; letter-spacing: 3px; color: var(--accent); text-transform: uppercase; font-weight: 700; }
    .card-date { font-size: 0.65rem; font-family: sans-serif; color: var(--muted); }
    .card-title { font-size: 1.1rem; font-weight: 700; margin: 0; }
    .card-desc { font-size: 0.8rem; color: var(--muted); margin: 0; line-height: 1.55; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .card-tags { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: auto; padding-top: 0.3rem; }
    .tech-tag { font-size: 0.62rem; font-family: sans-serif; letter-spacing: 1px; padding: 2px 7px; border: 1px solid var(--border); border-radius: 3px; color: var(--muted); }
    .card-links { display: flex; gap: 0.5rem; }
    .link-chip { font-size: 0.65rem; font-family: sans-serif; letter-spacing: 1px; color: var(--accent); transition: 0.3s; }
    .project-card:hover .link-chip { color: var(--ink); }

    @media (max-width: 850px) { .projects-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .projects-grid { grid-template-columns: 1fr; } }
</style>
