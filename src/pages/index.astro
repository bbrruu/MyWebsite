---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

// 1. 抓取所有內容並排序
const allJournalPosts = (await getCollection("blog")).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
const allResearchPosts = (await getCollection("research")).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
const allReadingPosts = (await getCollection("reading")).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
const allMusicPosts = (await getCollection("music")).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
const featuredProjects = (await getCollection("projects"))
    .filter((p: CollectionEntry<"projects">) => p.data.featured)
    .sort((a: CollectionEntry<"projects">, b: CollectionEntry<"projects">) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 3);

const slogans = [
    "想買一桶冰淇淋暴挖起來吃",
    "有一隻貓咪叫做高麗菜",
    "中文字體要什麼才會好看呢",
    "蛋餅蛋餅九層塔蛋餅",
];
const randomSlogan = slogans[Math.floor(Math.random() * slogans.length)];
---

<Layout title="Bruce 個人網站">
    <div class="paper-texture"></div>

    <main class="container">

        <header class="banner-header">
            <a href="/about" class="banner-link-wrapper">
                <div class="banner-bg">
                    <img src="/images/banner.webp" alt="Academic Banner" />
                    <div class="banner-overlay"></div>
                </div>
                <div class="banner-content">
                    <h1 class="banner-title">Bruce 的個人網站</h1>
                    <div id="slogan" class="banner-slogan">{randomSlogan}</div>
                    
                    <div class="profile-cta">
                        <span class="cta-text">關於我 / VIEW PROFILE</span>
                        <div class="cta-line"></div>
                    </div>
                </div>
            </a>
        </header>

        {featuredProjects.length > 0 && (
            <section class="featured-projects">
                <div class="fp-header">
                    <div class="fp-title-group">
                        <span class="fp-label">SIDE PROJECTS</span>
                        <h2 class="fp-title">作品集 <span class="fp-sub">FEATURED WORKS</span></h2>
                    </div>
                    <a href="/projects" class="fp-view-all">查看全部 →</a>
                </div>
                <div class="fp-grid">
                    {featuredProjects.map((project: CollectionEntry<"projects">) => (
                        <a href={`/projects/${project.id}`} class="fp-card">
                            <div class="fp-cover">
                                {project.data.coverImage
                                    ? <img src={project.data.coverImage} alt={project.data.title} />
                                    : <div class="fp-cover-placeholder"><span>{project.data.techStack[0] || "?"}</span></div>
                                }
                                <span class={`fp-status fp-status--${project.data.status.toLowerCase()}`}>
                                    {project.data.status}
                                </span>
                            </div>
                            <div class="fp-info">
                                <h3 class="fp-name">{project.data.title}</h3>
                                <p class="fp-desc">{project.data.description}</p>
                                <div class="fp-tags">
                                    {project.data.techStack.slice(0, 3).map((tech: string) => (
                                        <span class="fp-tag">{tech}</span>
                                    ))}
                                </div>
                                <div class="fp-links">
                                    {project.data.demoUrl && <span class="fp-link-badge">Demo</span>}
                                    {project.data.githubUrl && <span class="fp-link-badge">GitHub</span>}
                                </div>
                            </div>
                        </a>
                    ))}
                </div>
            </section>
        )}

        <div class="quad-grid">
            <section class="home-section">
                <a href="/blog" class="section-title-link">
                    <div class="title-container">
                        <h2 class="section-title">生活隨筆<div class="hover-accent-line"></div></h2>
                        <span class="section-en">JOURNAL</span>
                    </div>
                    <span class="enter-arrow">→</span>
                </a>
                <div class="section-content">
                    {allJournalPosts.slice(0, 3).map((post) => (
                        <a href={`/blog/${post.id}`} class="preview-item">
                            <div class="preview-date">
                                <span class="p-year">{post.data.pubDate.getFullYear()}</span>
                                <span class="p-day">{post.data.pubDate.getDate()}日</span>
                            </div>
                            <div class="preview-body">
                                <h3 class="p-title">{post.data.title}</h3>
                                <p class="p-excerpt">{post.data.mood || "今日無事"}</p>
                            </div>
                        </a>
                    ))}
                    <div class="see-more-wrapper">
                        <a href="/blog" class="see-more-btn">查看更多 MORE<div class="btn-line"></div></a>
                    </div>
                </div>
            </section>

            <section class="home-section">
                <a href="/research" class="section-title-link">
                    <div class="title-container">
                        <h2 class="section-title">讀讀文獻<div class="hover-accent-line"></div></h2>
                        <span class="section-en">LITERATURE</span>
                    </div>
                    <span class="enter-arrow">→</span>
                </a>
                <div class="section-content">
                    {allResearchPosts.slice(0, 3).map((post) => (
                        <a href={`/research/${post.id}`} class="preview-item">
                            <div class="preview-date">
                                <span class="p-year">{post.data.pubDate.getFullYear()}</span>
                                <span class="p-day">{post.data.pubDate.getDate()}日</span>
                            </div>
                            <div class="preview-body">
                                <h3 class="p-title">{post.data.title}</h3>
                                <p class="p-excerpt">{post.data.category || "學術探究"}</p>
                            </div>
                        </a>
                    ))}
                    <div class="see-more-wrapper">
                        <a href="/research" class="see-more-btn">查看更多 MORE<div class="btn-line"></div></a>
                    </div>
                </div>
            </section>

            <section class="home-section">
                <a href="/reading" class="section-title-link">
                    <div class="title-container">
                        <h2 class="section-title">看看書籍<div class="hover-accent-line"></div></h2>
                        <span class="section-en">READING</span>
                    </div>
                    <span class="enter-arrow">→</span>
                </a>
                <div class="section-content">
                    {allReadingPosts.slice(0, 3).map((post) => (
                        <a href={`/reading/${post.id}`} class="preview-item">
                            <div class="preview-date">
                                <span class="p-year">{post.data.pubDate.getFullYear()}</span>
                                <span class="p-day">{post.data.pubDate.getDate()}日</span>
                            </div>
                            <div class="preview-body">
                                <h3 class="p-title">{post.data.title}</h3>
                                <p class="p-excerpt">{post.data.author || "書海拾貝"}</p>
                            </div>
                        </a>
                    ))}
                    <div class="see-more-wrapper">
                        <a href="/reading" class="see-more-btn">查看更多 MORE<div class="btn-line"></div></a>
                    </div>
                </div>
            </section>

            <section class="home-section">
                <a href="/music" class="section-title-link">
                    <div class="title-container">
                        <h2 class="section-title">聽聽音樂<div class="hover-accent-line"></div></h2>
                        <span class="section-en">MUSIC</span>
                    </div>
                    <span class="enter-arrow">→</span>
                </a>
                <div class="section-content">
                    {allMusicPosts.slice(0, 3).map((post) => (
                        <a href={`/music/${post.id}`} class="preview-item">
                            <div class="preview-date">
                                <span class="p-year">{post.data.pubDate.getFullYear()}</span>
                                <span class="p-day">{post.data.pubDate.getDate()}日</span>
                            </div>
                            <div class="preview-body">
                                <h3 class="p-title">{post.data.title}</h3>
                                <p class="p-excerpt">{post.data.artist || "旋律回響"}</p>
                            </div>
                        </a>
                    ))}
                    <div class="see-more-wrapper">
                        <a href="/music" class="see-more-btn">查看更多 MORE<div class="btn-line"></div></a>
                    </div>
                </div>
            </section>
        </div>
    </main>
</Layout>

<script define:vars={{ slogans, randomSlogan }}>
    function setupPageLogic() {
        // 時鐘
        const clockElement = document.getElementById("live-time");
        if (window.clockInterval) clearInterval(window.clockInterval);
        function updateTime() {
            const now = new Date();
            if (clockElement) clockElement.textContent = now.toLocaleTimeString("zh-TW", { hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" });
        }
        if (clockElement) { updateTime(); window.clockInterval = setInterval(updateTime, 1000); }

        // 標語輪播
        const sloganElement = document.getElementById("slogan");
        if (window.sloganInterval) clearInterval(window.sloganInterval);
        let currentIndex = slogans.indexOf(randomSlogan);
        function updateSlogan() {
            if (!sloganElement) return;
            sloganElement.style.opacity = "0";
            setTimeout(() => {
                currentIndex = (currentIndex + 1) % slogans.length;
                sloganElement.textContent = slogans[currentIndex];
                sloganElement.style.opacity = "1";
            }, 500);
        }
        if (sloganElement) { window.sloganInterval = setInterval(updateSlogan, 3000); }
    }
    document.addEventListener("astro:page-load", setupPageLogic);
</script>

<style>
    :root {
        --ink: #2c2c2c;
        --paper: #fdfaf6;
        --accent: #8b4513;
        --muted: #8e8e8e;
        --border: #e0dcd5;
    }

    body { background-color: var(--paper); color: var(--ink); font-family: "Noto Serif TC", serif; margin: 0; }
    .paper-texture { position: fixed; inset: 0; z-index: -1; opacity: 0.03; background-image: url("https://www.transparenttextures.com/patterns/paper-fibers.png"); pointer-events: none; }
    .container { max-width: 1400px; margin: 0 auto; padding: 0; }

    /* 導覽列 */
    .nav-links { display: flex; gap: 1.5rem; }
    .nav-links a { text-decoration: none; color: var(--muted); transition: 0.3s; font-size: 0.9rem; letter-spacing: 1px; }
    .nav-links a:hover, .nav-about, .nav-index { color: var(--ink); font-weight: 700; }
    .current-time { color: var(--accent); font-family: monospace; }

    /* Banner */
    .banner-header { position: relative; width: 100%; height: 260px; margin-bottom: 2.5rem; overflow: hidden; }
    .banner-link-wrapper { display: block; width: 100%; height: 100%; text-decoration: none; color: inherit; }
    .banner-bg { position: absolute; inset: 0; z-index: -1; }
    .banner-bg img { width: 100%; height: 100%; object-fit: cover; transition: transform 1.2s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .banner-link-wrapper:hover .banner-bg img { transform: scale(1.03); }

    .banner-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(253, 250, 246, 0.3), var(--paper)); }

    .banner-content { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2; text-align: center; }
    .banner-title { font-size: 2.2rem; margin: 0; font-weight: 700; letter-spacing: -1px; }
    .banner-slogan { font-size: 0.9rem; margin-top: 0.7rem; color: black; font-style: italic; letter-spacing: 0.1rem; transition: opacity 0.5s; }

    /* View Profile */
    .profile-cta { margin-top: 1.5rem; position: relative; padding-bottom: 6px; font-weight: bold; }
    .cta-text { font-size: 0.7rem; font-family: sans-serif; color: black; letter-spacing: 2px; transition: 0.4s; }
    .cta-line { position: absolute; bottom: 0; left: 50%; width: 30px; height: 1px; background-color: var(--border); transform: translateX(-50%); transition: 0.4s; }

    .banner-link-wrapper:hover .cta-text { color: var(--accent); }
    .banner-link-wrapper:hover .cta-line { width: 120px; background-color: var(--accent); }

    /* Featured Projects */
    .featured-projects { margin-bottom: 3rem; }

    .fp-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.2rem; padding-bottom: 0.7rem; border-bottom: 1px solid var(--border); }
    .fp-label { font-size: 0.6rem; font-family: sans-serif; letter-spacing: 4px; color: var(--accent); display: block; margin-bottom: 0.3rem; text-transform: uppercase; }
    .fp-title { font-size: 1.4rem; margin: 0; font-weight: 700; }
    .fp-sub { font-size: 0.7rem; font-family: sans-serif; letter-spacing: 3px; color: var(--muted); font-weight: 400; margin-left: 0.5rem; }
    .fp-view-all { font-size: 0.75rem; font-family: sans-serif; letter-spacing: 2px; color: var(--muted); text-decoration: none; transition: 0.3s; }
    .fp-view-all:hover { color: var(--accent); }

    .fp-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.2rem; }

    .fp-card {
        text-decoration: none; color: inherit;
        border: 1px solid var(--border); border-radius: 4px;
        overflow: hidden; transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
        display: flex; flex-direction: column;
    }
    .fp-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(139,69,19,0.1); border-color: var(--accent); }

    .fp-cover { position: relative; height: 140px; overflow: hidden; background: var(--border); }
    .fp-cover img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s; }
    .fp-card:hover .fp-cover img { transform: scale(1.04); }
    .fp-cover-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(139,69,19,0.08), rgba(139,69,19,0.18)); }
    .fp-cover-placeholder span { font-family: sans-serif; font-size: 0.75rem; letter-spacing: 3px; color: var(--accent); text-transform: uppercase; font-weight: 700; }

    .fp-status { position: absolute; top: 0.6rem; right: 0.6rem; font-size: 0.6rem; font-family: sans-serif; letter-spacing: 1px; padding: 2px 7px; border-radius: 20px; font-weight: 700; }
    .fp-status--active { background: rgba(34,197,94,0.15); color: #16a34a; }
    .fp-status--wip { background: rgba(249,115,22,0.15); color: #ea580c; }
    .fp-status--archived { background: rgba(100,116,139,0.15); color: #64748b; }

    .fp-info { padding: 0.9rem; display: flex; flex-direction: column; gap: 0.4rem; flex: 1; }
    .fp-name { font-size: 1rem; font-weight: 700; margin: 0; }
    .fp-desc { font-size: 0.78rem; color: var(--muted); margin: 0; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .fp-tags { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-top: auto; }
    .fp-tag { font-size: 0.62rem; font-family: sans-serif; letter-spacing: 1px; padding: 2px 7px; border: 1px solid var(--border); border-radius: 3px; color: var(--muted); }
    .fp-links { display: flex; gap: 0.5rem; }
    .fp-link-badge { font-size: 0.6rem; font-family: sans-serif; letter-spacing: 1px; padding: 2px 7px; background: rgba(139,69,19,0.08); color: var(--accent); border-radius: 3px; }

    @media (max-width: 768px) { .fp-grid { grid-template-columns: 1fr; } }

    /* 四宮格 */
    .quad-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
    .section-title-link { display: flex; justify-content: space-between; align-items: flex-end; text-decoration: none; color: var(--ink); padding-bottom: 0.7rem; border-bottom: 1px solid var(--border); margin-bottom: 1.2rem; }
    .title-container { position: relative; display: flex; align-items: baseline; gap: 1.2rem; }
    .section-en { margin-left: 0.5rem; }
    .section-title { font-size: 1.7rem; margin: 0; transition: transform 0.4s, color 0.4s; position: relative; }
    .hover-accent-line { position: absolute; bottom: -6px; left: 0; width: 0; height: 3px; background-color: var(--accent); transition: width 0.35s ease; transition-delay: 0s; }
    .enter-arrow { font-size: 1rem; color: var(--muted); opacity: 0; transform: translateX(-10px); transition: 0.4s; }

    .section-title-link:hover .section-title { transform: translateX(10px); color: var(--accent); }
    .section-title-link:hover .hover-accent-line { width: 100%; transition-delay: 0.25s; }
    .section-title-link:hover .enter-arrow { opacity: 1; transform: translateX(0); color: var(--accent); }

    .preview-item { display: flex; gap: 1.2rem; text-decoration: none; color: inherit; padding: 0.55rem 0.6rem; border-bottom: 1px dashed var(--border); transition: 0.3s; }
    .preview-item:hover { background: rgba(139, 69, 19, 0.03); transform: translateX(8px); }
    .preview-date { min-width: 52px; text-align: right; border-right: 1px solid var(--border); padding-right: 0.8rem; }
    .p-year { font-size: 0.6rem; color: var(--muted); display: block; }
    .p-day { font-size: 0.9rem; font-weight: 700; }

    .see-more-wrapper { display: flex; justify-content: flex-end; margin-top: 0.8rem; }
    .see-more-btn { text-decoration: none; color: var(--muted); font-size: 0.7rem; letter-spacing: 2px; position: relative; padding: 8px 0; transition: 0.3s; }
    .btn-line { position: absolute; bottom: 0; right: 0; width: 30px; height: 2px; background-color: var(--border); transition: 0.4s; }
    .see-more-btn:hover { color: var(--accent); }
    .see-more-btn:hover .btn-line { width: 100%; background-color: var(--accent); }

    @media (max-width: 768px) { .quad-grid { grid-template-columns: 1fr; } }
</style>